# 核心板操作系统部署_补全版

## 0. 硬件与分区规划

你的 NVMe 盘 119.2G，3 个分区（p2 当前挂载为 /）。原文 lsblk 结构如下：

- nvme0n1p1：20G
- nvme0n1p2：50G（当前 Fedora rootfs）
- nvme0n1p3：48G（空分区，准备装 openEuler server rootfs）

建议用途（按你的目标）：

- **p1**：openEuler embedded（用于兜底）
- **p2**：Fedora rootfs + Phytium(embedded) 内核（你现在工作的主环境）
- **p3**：openEuler server 用户态 rootfs +（先复用 Phytium embedded 内核/DTB，后续再替换为 server/BSP 内核）

---

## 1. U-Boot 启动 initramfs Linux 系统

### 1.1 TFTP 根目录

在 windows PC 上：

把 `Image`、`pd2008-devboard-dsk.dtb`、`initramfs.cpio` 放到你的 TFTP 根目录。

这 3 个文件将启动一个在内存中运行的 linux 系统

然后在 MoboXterm 中选择 tftp server, 读取目录指定为你的 TFTP 根目录

### 1.2 U-Boot 侧启动命令

你现在环境变量地址看起来没冲突（kernel 0x80200000、fdt 0x8f000000、ramdisk 0x90000000），OK。

建议你用下面顺序（**initramfs 下载后立即 setenv rdsize**）：

```bash
setenv serverip 192.168.11.100
setenv ipaddr   192.168.11.102

setenv kernel_addr_r    0x80200000
setenv fdt_addr_r       0x8F000000
setenv ramdisk_addr_r   0x90000000
setenv fdt_high         0xffffffffffffffff
setenv initrd_high      0xffffffffffffffff

tftpboot ${kernel_addr_r} Image

tftpboot ${ramdisk_addr_r} initramfs.cpio
setenv rdsize ${filesize}

tftpboot ${fdt_addr_r} pd2008-devboard-dsk.dtb

setenv bootargs 'console=ttyAMA1,115200 earlycon=pl011,0x28001000 loglevel=8 rdinit=/init'
booti ${kernel_addr_r} ${ramdisk_addr_r}:${rdsize} ${fdt_addr_r}
```

> 注意：initramfs.cpio 没有压缩比较大，有 297M，下载时间 1M/s 需要 5 分钟。

---

## 2. 进入 initramfs 后：刷盘基本流程

### 2.1 测试网络连通性

系统启动之后，进入`bash-5.2#` 环境，IP 已经配置为 `192.168.11.101(eth0)` `192.168.11.102(eth1)`

查看网络接口和 IP

```text
ip a
```

假设 PC 端设置为 `192.168.11.100`，网络应该直接可用。

> 注意，一定要采用带次数的 `ping` 命令测试网络连通性，否则可能因为 `bash` 无法接收串口传入的 `Ctrl^C` 中断信号，导致刷屏无法中断。
> ```bash
> ping -c 3 192.168.11.100
> ```

### 2.2 时间设置和创建磁盘分区

设置系统时间：

```bash
date -s "2027-12-31 12:00:00"
```

分区和创建文件系统: 创建 3 个分区：

- nvme0n1p1：20G
- nvme0n1p2：50G（当前 Fedora rootfs）
- nvme0n1p3：48G（空分区，准备装 openEuler server rootfs）

```shell
fdisk /dev/nvme0n1
```

创建完：

```text
Command (m for help): p

Disk /dev/nvme0n1: 119.24 GiB, 128035676160 bytes, 250069680 sectors
Disk model: SC6912011-SB128BGJ
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x00000000

Device         Boot     Start       End   Sectors  Size Id Type
/dev/nvme0n1p1           2048 125831167 125829120   60G 83 Linux
/dev/nvme0n1p2      125831168 250069679 124238512 59.2G 83 Linux
/dev/nvme0n1p3      125831168 250069679 124238512 59.2G 83 Linux

Filesystem/RAID signature on partition 1 will be wiped.
Filesystem/RAID signature on partition 2 will be wiped.
Filesystem/RAID signature on partition 3 will be wiped.
```

格式化为 ext4 文件系统：

```bash
mkfs.ext4 /dev/nvme0n1p1
mkfs.ext4 /dev/nvme0n1p2
mkfs.ext4 /dev/nvme0n1p3
```

创建完：

```text
# blkid
/dev/nvme0n1p1: UUID="acf1fe2f-13fd-4b82-9d1b-ae6a6fec63ec" BLOCK_SIZE="4096" TYPE="ext4"
/dev/nvme0n1p2: UUID="9c5fa5ac-4851-4031-ac19-c68b30893248" BLOCK_SIZE="4096" TYPE="ext4"
/dev/nvme0n1p3: UUID="9c5fa5ac-4851-4031-ac19-c68b30893248" BLOCK_SIZE="4096" TYPE="ext4"
```

### 2.3 http.server

在 WSL 中，进入存放操作系统镜像的目录

```text
wuyuhang@Tokamark-2:~/wuyh/Desktop/Alpha$ ls
Image initramfs.cpio  p2-rootfs.tar  pd2008-devboard-dsk.dtb  rootfs.ext4
wuyuhang@Tokamark-2:~/wuyh/Desktop/Alpha$ pwd
/home/wuyuhang/wuyh/Desktop/Alpha
```

打开一个 `http.server`:

```bash
python3 -m http.server 8000 --bind 0.0.0.0
```

### 2.4 将操作系统镜像写入 SSD

在内存中启动的这个 Linux 轻量系统的文件系统完全在内存中，大小只有 8G，因此要写入比较大的磁盘镜像需要先挂载 ssd 分区，然后再写入。

#### 2.4.1 nvme0n1p1

写入 openeuler embedded 系统：

```bash
lsblk -f
blkid

mkdir -p /mnt/p1
mount /dev/nvme0n1p1 /mnt/p1
```

然后拉 p1-rootfs.tar

```bash
cd /mnt/p1
ping -c 2 192.168.11.100
curl -LO http://192.168.11.100:8000/p1-rootfs.tar
```

解压操作系统镜像包

```bash
tar -xpf p1-rootfs.tar -C /mnt/p1
sync
```

```bash
umount /dev/nvme0n1p1
```

#### 2.4.2 nvme0n1p2

写入 fedora 43 系统镜像：

```bash
lsblk -f
blkid

mkdir -p /mnt/p2
mount /dev/nvme0n1p1 /mnt/p2
```

然后拉 p2-rootfs.tar

```bash
cd /mnt/p2
ping -c 2 192.168.11.100
curl -LO http://192.168.11.100:8000/p2-rootfs.tar
```

解压操作系统镜像包

```bash
tar -xpf p2-rootfs.tar -C /mnt/p2
sync
```

```bash
umount /dev/nvme0n1p2
```

#### 2.4.3 nvme0n1p3

写入 openeuler server ext4 镜像

openeuler server 发布的是 ext4 镜像，体积为 8G，需要借助 nvme0n1p2 中转。

```bash
lsblk -f
blkid

mkdir -p /mnt/p2
mount /dev/nvme0n1p2 /mnt/p2
```

然后拉 rootfs：

```text
cd /mnt/p2/root
ping -c 2 192.168.11.100
curl -LO http://192.168.11.100:8000/rootfs.ext4
```

写入镜像到 nvme0n1p3，无需挂载 p3

```bash
dd if=rootfs.ext4 of=/dev/nvme0n1p3 bs=16M status=progress
sync
```

记得卸载 p2

```bash
umount /dev/nvme0n1p2
```

现在 3 个系统都已经写入 ssd, 接下来设置 U-Boot 环境变量进入不同系统即可。

## 3. U-Boot 启动相关（固定地址 + p1 booti / p2+p3 bootefi）

nvme ssd 将创建 3 个分区并安装 3 个版本的操作系统，使用不同的参数进行启动：

```text
run bootcmd_nvme
run boot_p2_efi
run boot_p3_efi
```

### 3.1 固定加载地址（3 个系统通用）

建议的安全地址（按你的板子内存可适当调整，三者别重叠）

```bash
setenv kernel_addr_r    0x80200000
setenv fdt_addr_r       0x8F000000
setenv ramdisk_addr_r   0x90000000
setenv fdt_high         0xffffffffffffffff
setenv initrd_high      0xffffffffffffffff
```

> 注意保存进 spi flash
> ```text
> saveenv
> ```

---

### 3.2 p1：openEuler embedded

控制台与启动参数

```bash
setenv console 'console=ttyAMA1,115200'
setenv bootargs "${console} root=/dev/nvme0n1p1 rw rootwait earlycon ignore_loglevel loglevel=8 audit=0"
```

NVMe 读文件并启动

```bash
setenv bootcmd_nvme 'pci init; nvme scan; \
ext4load nvme 0:1 ${kernel_addr_r} /boot/Image; \
ext4load nvme 0:1 ${fdt_addr_r}    /boot/dtbs/pd2008-devboard-dsk.dtb; \
booti ${kernel_addr_r} - ${fdt_addr_r}'
```

> 注意保存进 spi flash
> ```bash
> saveenv
> ```

**启动 embedded 直接：**

```bash
run bootcmd_nvme
```

---

### 3.3 p2：Fedora（bootefi）

#### 3.3.1 Fedora 的 bootargs

```bash
setenv bootargs_p2 'root=/dev/nvme0n1p2 rootfstype=ext4 console=ttyAMA1,115200 console=ttyAMA0,115200 earlycon=pl011,0x28001000 loglevel=8 ignore_loglevel rw rootwait nr_cpus=8 nmi_watchdog=0 panic=-1 init=/lib/systemd/systemd'
```

#### 3.3.2 Fedora bootefi 启动命令（固化成 run）

> 注意：**只加载一个内核文件**，不要两次 ext4load 覆盖。

```bash
setenv boot_p2_efi '\
pci init; nvme scan; \
setenv bootargs ${bootargs_p2}; \
ext4load nvme 0:2 ${kernel_addr_r} /boot/Image; \
ext4load nvme 0:2 ${fdt_addr_r} /boot/dtb/pd2008-devboard-dsk.dtb; \
fdt addr ${fdt_addr_r}; \
fdt resize 1024; \
fdt set /chosen bootargs "${bootargs}"; \
bootefi ${kernel_addr_r} ${fdt_addr_r}'
```

> 注意保存进 spi flash
> ```bash
> saveenv
> ```


启动 Fedora：

```bash
run boot_p2_efi
```

---

### 3.4 p3：openEuler server（bootefi）

#### 3.4.1 p3 的 bootargs

```bash
setenv bootargs_p3 'root=/dev/nvme0n1p3 rootfstype=ext4 console=ttyAMA1,115200 console=ttyAMA0,115200 earlycon=pl011,0x28001000 loglevel=8 ignore_loglevel rw rootwait nr_cpus=8 nmi_watchdog=0 panic=-1 init=/lib/systemd/systemd'
```

#### 3.4.2 p3 bootefi 启动命令

```bash
setenv boot_p3_efi '\
pci init; nvme scan; \
setenv bootargs ${bootargs_p3}; \
ext4load nvme 0:3 ${kernel_addr_r} /boot/Image; \
ext4load nvme 0:3 ${fdt_addr_r} /boot/dtb/pd2008-devboard-dsk.dtb; \
fdt addr ${fdt_addr_r}; \
fdt resize 1024; \
fdt set /chosen bootargs "${bootargs}"; \
bootefi ${kernel_addr_r} ${fdt_addr_r}'
```

> 注意保存进 spi flash
> ```bash
> saveenv
> ```

启动 p3：

```bash
run boot_p3_efi
```

启动 openeuler server之后，你看到的系统磁盘大小仅为 8G，需要使用下面的命令扩充 / 目录到 p3 分区大小：

```text
resize2fs /dev/nvme0n1p3
```

---

最后你可以使用不同的 U-Boot 环境变量进入不同的操作系统，通过网络的配置，使用 SSH 登录系统，并加载安装更多的软件
