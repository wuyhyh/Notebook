# 内网文档服务器部署

为了方便查阅内部文档，利用内网 Linux 服务器上实现项目文档托管。

现在的站点是 **纯静态**（Sphinx 构建出的 `site/` 目录）的，
在服务器上**只需要部署 `site/` 里的文件**并用一个静态 Web 服务器提供访问即可。

下面给出一套在 **Fedora Server 42** 上的部署流程，并附上**迁移到 Ubuntu** 时的等价命令。

---

## 一、准备阶段（在 Windows 上）

1. **本地构建**

   ```powershell
   # 进入你的项目
   sphinx-build -b html docs/source site
   ```

   构建完成后，`site/` 就是要放到服务器上的内容。

2. **确认可通过 SSH 访问 Fedora**

    * 已能 `ssh fedora@<Fedora_IP>`（用户名按你的虚机设置）。
    * Windows 自带 `scp` 客户端（OpenSSH），PowerShell 或者 Git bash 里可直接用。

---

## 二、在 Fedora 上安装并启用 NGINX（一次性）

```bash
# 以 root 或 sudo 执行
sudo dnf install -y nginx

# 开机自启 + 立即启动
sudo systemctl enable --now nginx

# 防火墙放行 80 端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload

# 查看服务器 IP（给浏览器访问）
ip addr | grep -E 'inet .* eth|ens|enp'
```

> 说明
>
> * 我们用 Nginx，因为轻量稳，静态站点非常合适。
> * 后面会把你的 `site/` 放到 `/srv/www/notebook/`

---

## 三、把 `site/` 同步到 Fedora

在 **git bash** 中执行（假设你的 Fedora 用户是 `root`，IP 是 `192.168.79.128`）：

```text
# 把本地 site/ 上传到服务器 /srv/www/notebook/（会自动创建）
scp -r ./site/* root@192.168.56.10:/tmp/site-upload/
ssh root@192.168.79.128 "sudo mkdir -p /srv/www/notebook && sudo rsync -a --delete /tmp/site-upload/ /srv/www/notebook/ && rm -rf /tmp/site-upload"
```

> 为了“原子性”，上面先传到 `/tmp`，再用 `rsync` 覆盖目标目录（带 `--delete` 保证清理陈旧文件）。

### SELinux（Fedora 默认开启）

把目录标记成 Web 可读（只需做一次；以后再覆盖无需重复）：

```bash
sudo semanage fcontext -a -t httpd_sys_content_t "/srv/www/notebook(/.*)?"
sudo restorecon -Rv /srv/www/notebook
```

如果系统没有 `semanage`：

```bash
sudo dnf install -y policycoreutils-python-utils
```

---

## 四、配置一个独立的 Nginx 站点

创建配置 `/etc/nginx/conf.d/notebook.conf`：

```nginx
server {
    listen 80;
    server_name _;      # 没有域名就用 "_"

    root /srv/www/notebook;
    index index.html;

    # 仅提供静态文件
    location / {
        try_files $uri $uri/ =404;
    }

    # 建议缓存策略（可选）
    location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # 压缩（可选）
    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
    gzip_min_length 1024;
}
```

检测并重载：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

现在在浏览器打开：`http://<Fedora_IP>/`，应该就能看到文档了。

> **放在子路径**（例如想用 `http://<IP>/docs/`）
> 把 `location /` 换成：
>
> ```nginx
> location /docs/ {
>     alias /srv/www/notebook/;
>     try_files $uri $uri/ =404;
> }
> ```
>
> 然后访问 `/docs/`。你的 Sphinx 产物使用相对路径，放子路径也能正常工作。

---

## 五、更新流程（以后每次改文档）

1. 在 Windows 上重新构建：

   ```powershell
   sphinx-build -b html docs/source site
   ```
2. 上传覆盖：

   ```powershell
   scp -r ./site/* fedora@192.168.79.128:/tmp/site-upload/
   ssh fedora@192.168.79.128 "sudo rsync -a --delete /tmp/site-upload/ /srv/www/notebook/ && rm -rf /tmp/site-upload"
   ```
3. **无需**重启 Nginx（纯静态文件替换即可）。

4. 如果提示服务器需要输入密码，需要进行 .ssh 配置

在 Git bash 中：

```text
cd ~
ssh-keygen
ssh-copy-id -i ~/.ssh/id_ed25519.pub your_username@fedora-server-ip
```

---

## 六、迁移到 Ubuntu（22.04/24.04 类似）

1. 安装 Nginx：

```bash
sudo apt update
sudo apt install -y nginx
sudo systemctl enable --now nginx
```

2. 开放防火墙（如果启用了 UFW）：

```bash
sudo ufw allow 'Nginx Full'
```

3. 放置站点文件：

```bash
sudo mkdir -p /var/www/notebook
# 从 Windows 上传（把 IP 换成 Ubuntu 的）
scp -r ./site/* ubuntu@<Ubuntu_IP>:/tmp/site-upload/
ssh ubuntu@<Ubuntu_IP> "sudo rsync -a --delete /tmp/site-upload/ /var/www/notebook/ && rm -rf /tmp/site-upload"
```

4. 配置站点 `/etc/nginx/sites-available/notebook`：

```nginx
server {
    listen 80;
    server_name _;

    root /var/www/notebook;
    index index.html;

    location / { try_files $uri $uri/ =404; }
    location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }
    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
    gzip_min_length 1024;
}
```

启用并重载：

```bash
sudo ln -s /etc/nginx/sites-available/notebook /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

> Ubuntu 默认没有 SELinux，不需要额外标记；Nginx 运行用户通常是 `www-data`，静态文件只需可读权限（默认即可）。

5. （可选）HTTPS：

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your.domain.com
```

---

## 七、手机端使用浏览器访问

要让**同一局域网的手机也能访问**，这里以 VMware 虚拟机中部署服务器的情况为例：

1. **如果用 NAT（不改 VMware 设置）**
   要在 VMware 里配置**端口转发**（Windows 把外部请求转发给虚拟机）。

    * 打开 VMware → 虚拟网络编辑器 → 选择 NAT 模式的网络 → 配置 NAT → 添加转发规则，例如：

      ```
      外部端口 8080 → 内部IP (Fedora NAT 地址) : 80
      ```
    * 然后在手机上访问：

      ```
      http://<Windows_IP>:8080/
      ```
    * Windows_IP 是安装虚拟机的宿主机在 WiFi 下的 IP（例如 `192.168.1.50`）。
    * 启动 Fedora 后，用命令查看分配的 IP：

      ```bash
      ip addr show
      ```

      你应该能看到一个类似 `192.168.x.x` 的地址（和手机的网段一致）。

---

2. **确认 Fedora 防火墙允许 HTTP**

   ```bash
   sudo firewall-cmd --permanent --add-service=http
   sudo firewall-cmd --reload
   ```

---

3. **手机访问**

    * 保证手机和 Fedora 虚拟机在同一个 WiFi。
    * 浏览器输入：

      ```
      http://<Fedora_IP>/
      ```

      例如：

      ```
      http://192.168.1.105/
      ```

---
