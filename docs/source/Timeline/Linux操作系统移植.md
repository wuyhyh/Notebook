# Linux 操作系统移植

## 1. 从网络加载文件系统

Linux 在串口终端显示登录提示符之前，会挂载一个**文件系统**。

一个**文件系统**由一组预定义的系统目录和文件组成，这些目录和文件按照特定的布局存储在磁盘或其他存储介质上。

Linux 可以挂载这些介质作为其**根文件系统**，最常见的情况是挂载一个**硬盘分区**作为根文件系统。

在开发环境中挂载 NFS 根文件系统是非常灵活的。

## 2. introduction

### 2.1 进入用户空间

内核会执行自己的代码，在一个称为**内核上下文**的环境中完成大量的初始化工作。

内核拥有所有的系统内存并且全权控制所有的系统资源。

当内核完成内部初始化并挂载根文件系统之后，默认会执行一个名为`init`的程序。

内核一启动 `init` ，随即进入了用户空间。

### 2.2 闪存

闪存可以在软件的控制下写入和擦除数据。

闪存的存储空间被分割为相对较大的可擦除单元，称为擦除块。

NOR型闪存芯片向某个存储地址写入数据的方法是直接将其从二进制1改为0，但是要将数据从0改为1就要擦除整个擦除块。
在擦除的时候需要向闪存芯片写入一串特别的控制指令序列。

为了修改闪存阵列中的数据，必须完全擦除待修改数据所在的块。

> 你可以一次将一个字节从1改成0，但如果想将某个比特从0改回1，则必须擦除整个块。

NOR型闪存可以被微处理器直接访问，NAND型闪存更适合以文件系统的格式大容量存储数据。

要对一个新的嵌入式内核和定制单板进行**压力测试**，一个好办法就是在上面反复编译Linux内核。

## 3. 处理器基础

独立处理器

片上系统 SoC

通过 PCI 扩展的专用处理板卡

## 4. Linux 内核

从项目的角度去考察内核的组织和结构：
如果你想添加一些代码，并且得到内核的支持，在哪里添加比较合适呢？
怎样知道哪些文件对你的架构重要？

### 4.1 背景

#### 4.1.1 内核版本

内核源码树的顶层目录包含一个 `Makefile` 文件，这个文件的开始几行详细说明了内核版本号。

查询内核的发布信息：

```text
cat /proc/version
```

如果你正在开发一些新的内核特性，可以设置 `EXTRAVERSION` 字段

```text
EXTRAVERSION = -foo
```

#### 4.1.2 内核源码树

针对某个架构的内核代码与主线内核代码都是有差异的。

一般项目使用的代码都是在主线最新的稳定版 Linux 源码树上应用补丁实现的。

### 4.2 Linux 内核的构造

Linux 内核的布局、组织和构造的问题清楚了，方便我们研究这个庞大的源码库。

#### 4.2.1 顶层源码目录

顶层源码目录的子目录中最大的是 driver/ 其次是 arch/

顶层目录中还包含一些重要的文件：

- 顶层 Makefile
- 一个隐藏的配置文件 .config
- 两个重要的构建目标文件 **System.map vmlinux** 内核构建成功后，在顶层目录中会生成这两个文件。

#### 4.2.2 编译内核

内核代码庞大而复杂，代码量太大了，不能简单通过走查代码来理解代码的含义。

内核的多线程和抢占特性使得代码分析更加复杂，实际上找到内核的入口点都不容易。

为了理解大的二进制镜像的结构，我们需要考察它的构建成员。

内核构建成功后，会生成一些公共文件及多个与具体架构相关的二进制模块。
有两个重要的公共文件是 System.map vmlinux

使构建时输出详细信息

```text
make V=1
```

#### 4.2.3 内核主体 vmlinux

`vmlinux` 是内核主体，是一个完整的 ELF 镜像，我们使用的则是它的压缩形式 `zImage`

大多数内核软件模块通过 `.config` 文件间接读取配置内容。
在构建过程中，构建系统会处理这个 `.config` 文件，并生成一个名为` autoconf.h` 的 C 语言头文件，放在 `include/generated` 中

在顶层目录输入 `make help` 可以得到一长串从源码树中生成的目标列表。

当指定了架构得到的 help 信息是不一样的。

```text
make ARCH=arm help
```

这里列出的目标中可能有许多你永远都用不上，但是知道这些目标存在是有好处的。
目标前有个 `*` ，表示这个目标会默认构建。
如果你想找到针对某个内核版本和架构的所有默认配置，这是个不错的方法。

内核构建系统会读取子目录下的 Kconfig 文件，这个文件用于配置所在目录的源码的特性。

每个 Kconfig 文件都可以随意指定处于源码树其他位置的 Kconfig 文件。
配置工具会递归读取这些链接在一起的 Kconfig 文件，构造出配置时所用的菜单结构。

这些 Kconfig 文件组合在一起决定了配置的菜单结构和配置选项，当用户配置内核时会看到他们。






