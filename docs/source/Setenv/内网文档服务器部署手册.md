# 内网文档服务器部署手册

> Rocky Linux 10 + GitLab 共存版：
>
> 适用场景：已经在 `rocky-server (192.168.1.102)` 上部署了 GitLab，现在希望在同一台机器上额外提供一套“纯静态 Sphinx
> 文档站点”，供局域网同事通过浏览器访问，并支持一键增量发布、避免线上残留。

---

## 0. 设计约束

1. 文档站点是纯静态产物，只需要把 Sphinx 构建出来的 `site/` 目录放到服务器上，然后用 Nginx 提供静态访问即可。
2. GitLab 自带 Nginx 会占用 80/443，你的“系统 Nginx”不要去抢 80/443；文档站用单独端口（本方案用 8081）。
3. Fedora/rocky 这类默认启用 SELinux：

    * 监听非标准端口需要把端口标成 `http_port_t`
    * 站点目录需要 `httpd_sys_content_t` 标签，否则容易出现 403（尤其是部署后文件标签不对）。
4. `scp` 直接覆盖不会删除旧文件，会产生“线上残留”。为了方便在没有 `rsync` 的 windows 环境下发布新版文档，采用“临时目录 +
   原子切换 + restorecon”的发布方式

---

## 1. 现网架构与路径约定

### 1.1 服务器端（Rocky 10）

* 服务器：`rocky-server`
* IP：`192.168.1.102`
* 文档站根目录：`/srv/www/notebook`
* 文档站访问地址：`http://192.168.1.102:8081/`
* Web 服务：系统 Nginx（`/usr/sbin/nginx`）
* GitLab：保持现状（不要改它的 Nginx/端口策略）

### 1.2 客户端（你的工程仓库）

* Sphinx 源码：`docs/source`
* 构建输出：`./site`（build.sh 会先清理再生成）
* 发布脚本：`./re_deployment.sh`（你会持续迭代它）

---

## 2. 服务器端一次性部署（只做一次）

以下命令在 `rocky-server` 上执行。

### 2.1 安装并启用系统 Nginx

```bash
sudo dnf install -y nginx policycoreutils-python-utils
sudo systemctl enable --now nginx
```

说明：`policycoreutils-python-utils` 提供 `semanage`，旧文档也提到 Fedora 下如果没有 `semanage` 要额外安装它。

### 2.2 创建站点目录

```bash
sudo mkdir -p /srv/www/notebook
```

旧文档也使用 `/srv/www/notebook/` 作为站点目录。

---

## 3. Nginx 配置（与 GitLab 共存）

### 3.1 文档站点配置文件

创建 `/etc/nginx/conf.d/notebook.conf`：

```nginx
server {
    listen 8081;
    server_name _;

    root /srv/www/notebook;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    # 可选：静态资源缓存
    location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # 可选：压缩
    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
    gzip_min_length 1024;
}
```

旧文档的同名配置（listen 80）结构基本一致；你现在仅把监听端口从 80 改为 8081，用于避开 GitLab。

### 3.2 配置检查并重启

```bash
sudo nginx -t
sudo systemctl restart nginx
```

---

## 4. 防火墙放行端口

因为你不使用 80，而使用 8081，需要显式放行：

```bash
sudo firewall-cmd --permanent --add-port=8081/tcp
sudo firewall-cmd --reload
```

验证监听：

```bash
sudo ss -lntp | grep -E '(:8081)\b' || true
```

---

## 5. SELinux 正确配置（避免 8081 启动失败与 403）

### 5.1 允许 Nginx 监听 8081（SELinux 端口类型）

```bash
sudo semanage port -a -t http_port_t -p tcp 8081
# 如果提示已存在但类型不对，用：
# sudo semanage port -m -t http_port_t -p tcp 8081
```

### 5.2 标记站点目录为 Web 可读（只需做一次）

旧文档明确要求对 `/srv/www/notebook` 设置 `httpd_sys_content_t` 并 `restorecon`。
Rocky 10 同样照做：

```bash
sudo semanage fcontext -a -t httpd_sys_content_t "/srv/www/notebook(/.*)?"
sudo restorecon -Rv /srv/www/notebook
```

### 5.3 发布后出现 403 的快速修复（常用）

当你做了目录切换/大量覆盖后，最稳的做法是再跑一次：

```bash
sudo restorecon -Rv /srv/www/notebook
sudo find /srv/www/notebook -type d -exec chmod 755 {} \;
sudo find /srv/www/notebook -type f -exec chmod 644 {} \;
```

---

## 6. 客户端构建流程（每次更新都要做）

### 6.1 build.sh 的行为与依赖

你的 `build.sh` 逻辑是：

* 清理旧 `./site`
* 在 `docs/source/_static/files` 下生成 sha256（默认只匹配 `.bin`）
* 调用 `sphinx-build` 构建 HTML 到 `./site`

因此客户端需要确保能直接执行 `sphinx-build`（Python Sphinx 已安装）。

### 6.2 执行构建

```bash
./build.sh
```

---

## 7. 发布流程（每次更新都要做）

### 7.1 为什么你初版脚本会“线上残留”

你当前仓库里那份 `re_deployment.sh` 初版本质是：

* 先跑 `./build.sh`
* 再 `scp -r site/*` 到 `/srv/www/notebook/`

这会导致：服务器上“你本地已删除的旧页面/旧资源”不会被删掉（线上残留）。

旧文档当时用的标准解法是：先上传到临时目录，再用 `rsync -a --delete` 覆盖目标目录并清理陈旧文件。

### 7.2 现行推荐：临时目录 + 原子切换 + restorecon（你现在的稳定方案）

你已经验证可用的最终策略建议固定为：

1. 本地 `./build.sh`
2. 远端准备临时目录（建议放在 `/srv/www/` 下，避免 `/tmp` 标签问题）
3. scp 上传到临时目录
4. 远端原子切换到 `/srv/www/notebook`
5. 发布完成后立刻 `restorecon -Rv /srv/www/notebook`（必要时顺便修权限）

要点：**原子切换负责“无残留”，restorecon 负责“无 403”。**

---

## 8. 免密发布（强烈建议）

如果每次都要输入密码，就需要做 `.ssh` 配置（ssh-keygen + ssh-copy-id）。

建议你在“实际运行发布脚本的环境”里做一次：

```bash
ssh-keygen -t ed25519
ssh-copy-id root@192.168.1.102
```

做完以后，`ssh/scp` 不会反复要密码，发布体验才算正常。

---

## 9. 验收清单

### 9.1 服务器端

* `systemctl status nginx` 显示 running
* `ss -lntp | grep :8081` 有监听
* `firewall-cmd --list-ports` 包含 `8081/tcp`
* `curl -I http://127.0.0.1:8081/` 返回 200/301（至少不是 403/500）

### 9.2 业务层

* 首页可打开
* 点击进入任意子页面不 403
* `_static/` 下的 css/js 能正常加载（浏览器控制台不报 403）

---

## 10. 常见问题与排障

### 10.1 Nginx 启动失败：端口被占用

```bash
sudo ss -lntp | egrep '(:80|:443|:8081|:8080)\b' || true
```

如果 80/443 被 GitLab 占着，不要硬抢，文档站就用 8081。

### 10.2 Nginx 启动失败：`bind() ... Permission denied`

优先检查 SELinux 端口类型是否允许：

```bash
sudo semanage port -l | grep -E '^http_port_t' | grep -E '\b8081\b' || true
```

没有就按 5.1 加进去。

### 10.3 访问 403（最典型）

直接按 5.3 跑一遍 `restorecon` 和权限修复。

同时看日志能更快定位：

```bash
sudo tail -n 80 /var/log/nginx/error.log
```
