# 技术问题时间线

记录解决的技术问题列表，和相关思路

---

## 7月-8月

### 20250708

七八月的时候的一些早期工作

#### 1. 使用 Git 进行版本管理，支持分布式协作开发

> Linux 服务器仓库
> ```text
> git clone ssh://git@172.16.21.220:2222/srv/git/ft-d2000_u-boot-v1.37.git
> ```
> ```text
> git clone ssh://git@172.16.21.220:2222/srv/git/image_fix_d2000_v1.71.git
> ```

#### 2. 建立分布式文档管理仓库，支持 md 文档离线浏览器阅读

> 本地仓库和 Linux 服务器仓库
> ```text
> git clone  C:/Users/wuyuhang/git-backups/HPC_project.git
> ```
> ```text
> git clone ssh://git@172.16.21.220:2222/srv/git/HPC_project.git
> ```

1. 摸清打包脚本PBF参数配置： DDR 训练、PCIe 工作模式配置问题的解决办法
2. 编译板级配置文件丢失，根据 `.config` 文件还原了板级配置
3. uboot 功能需要进一步定制，需要修改版级配置文件，使用 `menuconfig`修改编译组件

```text
make ARCH=arm CROSS_COMPILE=aarch64-linux-gnu- hpc_board_defconfig
```

4. 飞腾 bsp

https://gitee.com/phytium_embedded/phytium-openeuler-embedded-bsp

使用飞腾的 firely 开发版提供的 bsp，移植 openEuler embedded 操作系统，使用 oe-build yocto 工程编译出
kernel dtb rootfs bootloader

5. oe-build

https://pages.openeuler.openatom.cn/embedded/docs/build/html/openEuler-22.03-LTS-SP4/yocto/index.html

### 20250827

1. PBF DDR training失败

解决办法是在 PBF 配置阶段关闭 one channel drive two slot

2. uboot shell 和 ramdisk Linux 找不到 nvme SSD

解决办法是在 PBF 配置阶段配置 PCIe 为 x8x8，RC mode

3. uboot 使用串口工具进行更新

下载 terarterm

## 9月

### 20250918

1. uboot 启动日志优化，缩短启动时间
2. 达成使用openEuler 5.10内核启动系统，但是沿用的是旧版 Linux 设备树和旧版根文件系统
3. 修改 ethact 环境变量，实现了uboot下两路网络通信

### 20250922

1. 下载根文件系统到 SSD
2. 解决操作系统内核对INFINIBAND的支持
3. 需要编译一个可用的ramdisk，现在的ramdisk启动概率性成功
4. 根文件系统已经启动，网络出现问题，PHY芯片驱动需要修改
5. 内核抢占模式需要修改
6. 内核ARMv8硬件加速需要关闭

### 20250923

1. 修改 uboot 网络驱动，支持 8211 芯片自动配置

### 20250924

1. PHY 芯片配置互相影响

```text
setenv ipaddr 192.168.11.102
setenv serverip 192.168.11.100
saveenv
```

```text
setenv enableNet "mii write 0x7 0x1e 0xa003; mii write 0x7 0x1f 0x8007;mii write 0x7 0x1e 0xa004; mii write 0x7 0x1f 0x00b0;mii write 0x7 0x1e 0xa001; mii write 0x7 0x1f 0x0164;mii read  0x7 0x11;"
saveenv
```

### 20250926

1. 网络问题
2. CPU0卡死
3. 新设备树编译问题

```text
./my_scripts/fix_parameter.sh
```

```text
make hpc_board_defconfig
```

### 20250928

1. 打包脚本有问题，导致SPL阶段启动失败，更换新的打包脚本包已解决问题
2. 新设备树版本的uboot网络设备无法识别
3. 串口正常，还不知道flash驱动是否正常，这涉及到qspi总线问题

### 20250929

1. 焊接了接地线，确保 flash disable，能从 emulator 启动
2. 更换设备树之后，系统无法启动

### 20250930

1. 继续适配设备树，找出不能启动的原因
2. 编译 fiptool 工具

```text
sudo apt-get install -y build-essential libssl-dev   # 若未安装依赖

git clone https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git

cd trusted-firmware-a/tools/fiptool

gcc -D_GNU_SOURCE -D_XOPEN_SOURCE=700 -O2 -Wall -Werror -pedantic -std=c99 \
    -I../../include/tools_share \
    fiptool.c tbbr_config.c \
    -lcrypto -o fiptool

./fiptool --help
```

```text
ls -l u-boot.dtb
```

设备树从1347B变为了9879B

## 10月

### 20251009

现象：

1. uboot在BL2阶段启动卡住
2. 设备树从1KB增大到9KB

猜想：

1. 设备树编译后体积增大，会不会真的引起fip.bin的布局错误？导致无法启动？

思路：

1. 修改打包脚本，fip.bin的布局中不需要的部分覆盖了没事，但是系统找不到需要启动的部分

### 20251010

1. uboot 的网络问题完全解决

### 20251011

1. flash 芯片温度敏感

温度高的时候flash写入或者读取数据可能有问题，这个最好看看手册里面有没有描述。
我观察到的现象是，确定软件没有问题，如果不加风扇，温度高的情况下写入uboot到flash，写入成功后，重启大概率异常。
如果我一直开风扇，在低温的状态下写入flash，然后重启一切正常。

很可能就是flash芯片温度导致之前我们误判flash坏了，再高温的时候，使用烧录器作为emulator启动uboot，完全可以正常启动。
flash芯片对温度可能比较敏感

结论：

如果一直打开散热风扇，系统工作正常

2. 完善 U-Boot 部分的文档

### 20251021

1. 使用新设备树编译的内核，启动之后支持多核，但是网络驱动有问题
2. 构建系统是否稳定呢？使用Ubuntu24.04编译中途没有出现问题

标准化编译出的内核和设备树的文件名，normalize-image.sh

#### 启动后的网络问题，需要手动更新 ARP 缓存。

`-I` 选项指定了发出 ping 包的源 IP，系统会自动选择对应的网口:

```text
ping -I 192.168.11.103 192.168.11.100   # 走 eth0
ping -I 192.168.11.104 192.168.11.100   # 走 eth1
```

查看当前路由表

```text
ip route show
```

```text
192.168.11.0/24 dev eth0 proto kernel scope link src 192.168.11.103
192.168.11.0/24 dev eth1 proto kernel scope link src 192.168.11.104
```

**问题在于**：系统有两条完全相同的路由指向同一子网，但没有指定优先级（metric）。
当 eth0 网线拔掉时，系统可能仍然尝试使用 eth0 路由，导致通信失败。

**临时测试**:
手动删除 eth0 的路由来测试

```bash
# 拔掉 eth0 网线后执行
ip route del 192.168.11.0/24 dev eth0
ping -I 192.168.11.104 192.168.11.100
```

如果这样能通，就确认是路由选择问题。

**解决办法**

测试当前路由选择
先查看系统当前选择哪条路由：

```text
ip route get 192.168.11.100
```

在 /etc/network/interfaces 或对应的网络配置文件中，为两个接口设置不同的 metric 值，数值越小优先级越高：

```bash
# 删除原有路由
ip route del 192.168.11.0/24 dev eth0
ip route del 192.168.11.0/24 dev eth1

# 添加带 metric 的路由（eth1 优先级更高）
ip route add 192.168.11.0/24 dev eth1 proto kernel scope link src 192.168.11.104 metric 100
ip route add 192.168.11.0/24 dev eth0 proto kernel scope link src 192.168.11.103 metric 200
```

### 20251023

1. 编译系统如何定制化内核？
2. 网络驱动如何加载
3. 如何启用网络 bonding，两路网络外部都有数据包流入时如何处理？放弃bonding，应用场景不需要
4. 制作 ramdisk 启动小型 Linux，10月27日已经形成基线版本

### 20251028

从网络加载根文件系统

- 编译机器 WSL: Ubuntu 24.04
- NFS 服务器 VMware: Fedora42，IP: 192.168.79.128
- Windows 11 用作 tftp server，以太网配置为静态IP: 192.168.11.100，有线连接。无线 WLAN 用于上外网，与开发调试无关。
- ARM64 开发板以太网有线连接，U-Boot IP: 192.168.11.101

## 编译机器

### 1.1 环境变量

在 Ubuntu 上使用 [oebuild 框架](../Build/oebuild构建系统.md)构建出内核、设备树、根文件系统。

添加镜像文件路径环境变量方便访问文件：

```text
echo 'export images_path=~/openeuler/workdir/build/phytium/tmp/deploy/images/phytium'
source ~/.bashrc
```

添加 NFS 服务器环境变量

```text
echo 'export nfs_root=root@192.168.79.128:/srv/nfsroot' >> ~/.bashrc
source ~/.bashrc
```

### 1.2 设置 SSH 免密访问

要实现SCP免密码传输文件，你需要设置SSH密钥认证。以下是具体步骤：

#### 1.2.1 生成SSH密钥对

在**源机器**（你当前操作的机器）上执行：

```bash
ssh-keygen -t rsa -b 4096
```

按回车接受默认保存路径（通常是 `~/.ssh/id_rsa`），设置一个空密码（直接回车两次）以实现完全免密。

#### 1.2.2 将公钥复制到目标机器

使用 `ssh-copy-id` 命令：

```bash
ssh-copy-id root@192.168.79.128
```

系统会提示你输入一次密码，这是最后一次需要输入密码。

#### 1.2.3 测试免密登录

```bash
ssh root@192.168.79.128
```

如果可以直接登录，说明设置成功。

#### 1.2.4 现在可以免密使用SCP

```bash
scp pd2008-devboard-dsk.dtb $nfs_root
```

### 1.3 复制根文件系统和内核模块到 NFS 服务器

> 注意：复制文件之前要先在 NFS 服务器端创建目录
> ```text
> mkdir -p /srv/nfsroot
> ```

```text
scp modules-phytium.tgz $nfs_root
scp openeuler-image-phytium.tar.bz2 $nfs_root
```

## 2. NFS 服务器

### 2.1 安装 NFSv4

### 2.1 把根文件系统解包到 nfsroot

```text
cd /srv/nfsroot
```

选用 tar.bz2 版本，保留权限/属主

```text
tar -xpf openeuler-image-phytium.tar.bz2 -C /srv/nfsroot --numeric-owner
```

解包内核模块（非常重要，根fs里要有 /lib/modules/<你的内核版本>）

```text
tar -xpf modules-phytium.tgz -C /srv/nfsroot --numeric-owner
```

验证：

```text
ls /srv/nfsroot/lib/modules
```

## 3. 开发板加载 NFS 根文件系统

```text
setenv ipaddr 192.168.11.101
setenv serverip 192.168.11.100
```

```text
tftpboot 0x90400000 Image-5.10.bin;tftpboot 0x90000000 pd2008.dtb
```

```text
setenv bootargs 'console=ttyS0,115200 root=/dev/nfs nfsroot=${serverip}:/srv/nfsroot,vers=4,proto=tcp rw ip=${ipaddr}::192.168.11.1:255.255.255.0:board:eth0:off'
```

```text
setenv bootargs 'console=ttyS0,115200 root=/dev/nfs nfsroot=${serverip}:/srv/nfsroot,vers=4,proto=tcp rw ip=dhcp'
```

```text
booti 0x90400000 - 0x90000000
```

TODO:
感觉内核没有编译NFS客户端，太麻烦了，我还是使用写入 ssd 的方法测试吧。

## 20251103-1107

1. 编译 initramfs，测试启动参数和网络功能、块设备管理，实现分区创建和文件系统创建。
2. 配置 wsl ssh server，开发板通过 initramfs 系统中的 ssh 登录和验证 scp 命令，实现 2G 文件一分钟内传送。

## 202512

### 操作系统选型问题

openEuler Embedded 内核稳定后，发现用户态根文件系统存在扩展性受限。
系统无法实现自举，没有办法为自己编译应用程序。

作为桌面级处理器为核心的异构加速计算单元，这是不可接受的。

需要移植稳定的 server 版本的 openEuler 操作系统，然后打上 phytium BSP，合并内核配置项，重新编译内核，并解决内核的稳定性问题。

### PCIe 总线实现 DPU 驱动加载

操作系统内核版本确定之后，需要进行 DPU 驱动适配，有可能需要重新编译 DPU 驱动。



