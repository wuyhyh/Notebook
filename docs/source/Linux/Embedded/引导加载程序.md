# 引导加载程序

## 1. 引导加载程序的作用

最简单的程序也需要在很多硬件初始化之后才能运行。

在加电并复位后，大多数处理器都会从一个默认的地址处获得代码。
硬件设计人员会根据这个信息安排板载闪存的布局，并选择闪存所对应的地址范围。

bootloader 负责完成基本的处理器和平台初始化，并获取和引导一个完整的操作系统。

高级功能：验证操作系统镜像，升级自身或操作系统镜像，选择某个操作系统启动。

## 2. 引导加载程序带来的挑战

bootloader 运行的时候是没有 C runtime environment 的基础设施的。

bootloader 需要的资源在使用之前必需先分配好并仔细初始化。

### 2.1 DRAM 控制器

bootloader 首先必须要做的工作之一是启用内存子系统。

完成内存初始化之后，bootloader 会将自己复制到 DRAM 中，以加快执行速度。

### 2.2 闪存与 RAM

bootloader 从闪存搬移到 RAM 中执行是复杂的。

### 2.3 镜像的复杂性

bootloader 在系统加电后获得控制权时，还不存在栈和栈指针。

在编译和链接生成 bootloader 时，开发人员必须控制镜像的构造和链接。

代码的组织结构要符合处理器的引导要求。

通过传递给链接器一个链接描述脚本，可以指定一个二进制镜像的布局。

> TODO 查看 uboot 代码中的 reset.S
> b _start

### 2.4 执行环境

硬件设计保证处理器可以从闪存中正确获取指令，并保证系统的时钟频率是个默认值，除此之外，
程序几乎不做任何假定。

处理器复位后的状态一般由处理器产商定义，但是板卡的复位状态由硬件设计人员定义。

有些处理器上有少量的 on-chip RAM，如果有 RAM，就可以将 RAM 的一部分作为栈，构建 C 语言运行环境。

## 3. 通用引导加载程序 U-Boot

### 3.1 获取 U-Boot

Das U-Boot

### 3.2 配置 U-Boot

输入命令配置：

```text
make <platform>_config
```

U-Boot 使用配置变量进行配置，这些变量在一个与具体板卡相关的头文件中定义。

配置选项 `CONFIG_XXXX` 是用户可配置的，会开启具体的 U-Boot 运行特性。

配置设置 `CONFIG-SYS-XXX` 一般是与硬件相关的，并且需要底层处理器或硬件平台的详细信息。

这些配置位于 `.../include/configs` 中的一个头文件中。
对板卡配置文件中添加定义，可以选择大量的特性和操作模式。

`.../configs/board_defconfig` 中定义了很多功能开关。

> TODO 如何定制 U-Boot?

### 3.3 U-Boot 的监控命令

U-Boot 命令集的工作方式？
主要的 U-Boot 命令集有哪些？
如何自定义 U-Boot 命令？

### 3.4 网络操作

简单文件传输协议 **TFTP** (Trivial File Transfer Protocol)

启动协议 **BOOTP** (Bootstrap Protocol)

动态主机配置协议 **DHCP**

### 3.5 存储子系统

U-Boot 可以从指定的原始分区或经过格式化(有文件系统)的分区中加载镜像。

### 3.6 从磁盘引导

例如：

```text
diskboot 0x400000 0:0
```
## 4. 移植 U-Boot

`config.mk`文件是次级目录中的 Makefile 文件。

一般与具体板卡相关的定义放在 `.../board/vendor/boardname` 子目录中。




