# 集特 GM9-2002 主板环境部署手册

> 安装操作系统、制作本地 yum 源、编译更换内核

## 1. 硬件

### 1.1 硬件清单（单台）

| 名称          | 数量 | 型号            | 备注                                |
|-------------|----|---------------|-----------------------------------|
| 飞腾 D2000 主板 | 1  | GM9-2002      | 目前该主板网卡驱动只支持麒麟操作系统，其他操作系统需使用USB网卡 |
| 内存          | 1  | 七彩虹 DDR4      | 单条容量 16G，频率 3200MHz               |
| SSD         | 1  | 七彩虹 CN600     | 256G，M.2 接口                       |
| 全模组电源       | 1  | SEASONIC ATX3 | 750W                              |
| 显卡          | 1  | AMD R5 230    | 主要用于前期更新固件和安装操作系统，后面接 PCIE 扩展卡    |
| 机箱          | 1  | AOCCG 391B    | 支持 M-ATX                          |
| U盘          | 1  | Kingston 64GB | 安装操作系统（目前使用openEuler）镜像           |
| USB 转串口线    | 1  | 力特科技 ze773    | 串口输出                              |

### 1.2 连接串口线

安装好主机之后连接串口线，之后从串口线监控系统的启动情况。

购买 USB-TTL 串口转接线，型号为 ，在[这个网站](https://www.z-tek.com)下载 `ZE773`驱动安装到 Windows 上

![ze773.png](../_static/_pic/ze773.png)

集特主板上有3 pin和4 pin的串口接线柱，我们选择连接 3pin。
连接 `GND TX RX`

![pin-3.png](../_static/_pic/pin-3.png)

另一端连接 Windows PC，并配置串口波特率为 115200.

### 1.3 安装显卡与升级主板固件

该型号的主板需要安装**独立显卡**才能支持图像输出。安装完显卡之后**只能**使用 HDMI 线连接显示器。

在安装完硬件之后如果 BIOS 固件版本过低需要进行升级，否则在 PCIe 插槽检测不到 GPU 时蜂鸣器会不断报警。

关闭显卡报警的固件：`without GPU`

在U盘中创建一个小分区，格式化为 FAT32 文件系统，然后将 '.fd' 固件复制到 U 盘中，然后进入BIOS 菜单根据指引升级固件。

## 2. 安装 openEuler 操作系统

### 2.1 镜像下载

选用软件生态和工具链完善的 ARM64 架构的 openEuler 22.03 SP4 server edition.

![openEuler.png](../_static/_pic/openEuler.png)

操作系统镜像在[这里](https://www.openeuler.org/zh/download/archive/detail/?version=openEuler%2022.03%20LTS%20SP4)
，选择下载服务器版的 Everything ISO 文件: `openEuler-22.03-LTS-SP4-everything-aarch64-dvd.iso`

### 2.2 安装操作系统

官方的安装指导在[这里](https://docs.openeuler.org/zh/docs/24.03_LTS_SP2/server/installation_upgrade/installation/installation_preparations.html)
，可供参考

#### 2.2.1 制作启动 U 盘

我们采用 U 盘制作 USB 启动盘进行安装，后续还可以使用这个 U 盘作为无网络情况下的本地 yum 源安装软件。

##### a. 下载 USB 盘制作工具，这里使用了 Ubuntu 社区的开源烧录工具 [balenaEtcher](https://etcher.balena.io/)

##### b. 准备一个 32G 或更大的U盘，使用 balenaEtcher 和下载好的 ISO 文件制作一个启动 U 盘

![usb_stick.png](../_static/_pic/usb_stick.png)

#### 2.2.2 安装操作系统

- 上电后按 F11 进入启动选项的选择，选择从 USB 启动
- 根据菜单提示进行安装，选择 `server`, 这里需要注意的是在 `software selection` 的时候选择上 `infiniband support` 和
  `development tools`
- 为 `/home` 目录分配 50GB 空间，其他空间全部分配给 `/`

系统安装好后重启进入 openEuler 系统

## 3. 配置本地 yum 源

### 3.1 查看当前块设备

插入启动 U 盘后，执行：

```sh
lsblk
```

可以看到 U 盘分区，假设 U 盘分区是 /dev/sda1，你可以挂载它到 /mnt/iso：

```sh
mkdir -p /mnt/iso
mount /dev/sda1 /mnt/iso
```

### 3.2 创建本地仓库文件

在 `/etc/yum.repos.d/` 目录下创建新的 `oe-local-iso.repo` 文件：

```bash
cat >/etc/yum.repos.d/oe-local-iso.repo <<'EOF'
[oe-local-iso]
name=openEuler local iso repo
baseurl=file:///mnt/iso
enabled=1
gpgcheck=0
metadata_expire=-1
EOF
```

### 3.3 刷新本地缓存

```sh
dnf clean all
dnf makecache
```

查看是否识别成功：

```sh
dnf repolist
```

应该能看到：

```text
repo id            repo name
oe-local-iso       OpenEuler Local iso Repo
```

接下来就可以使用本地源安装软件，比如 `cmake`

```sh
dnf install -y cmake
```

## 4. 本地编译内核

### 4.1 准备源码

先使用在 windows PC 上复制源码与配置文件到 U 盘 (**注意不是启动盘**，是另一个 U 盘)

- `openeuler-5.10.0-136-src-master.tar.gz`
- `config-5.10.0-136.12.0.86.aarch64`

然后插入 U 盘到开发板，挂在 U 盘，并将源码复制到 `/root` 目录

```sh
lsblk
```

可以看到 U 盘分区，假设 U 盘分区是 /dev/sda1，你可以挂载它到 /mnt：

```sh
mount /dev/sda1 /mnt
```

复制源码：

```text
cd /mnt;ls
cp -v openeuler-5.10.0-136-src-master.tar.gz config-5.10.0-136.12.0.86.aarch64 ~
```

复制完后 umount U 盘，然后拔掉 U 盘

```text
cd ~;
umount /dev/sda1
```

### 4.2 基础构建工具安装

**重新插入**启动 U 盘，作为本地 yum 源，然后安装工具：

在开发板上（aarch64 openEuler）：

```bash
sudo dnf install -y \
  gcc gcc-c++ make \
  bc bison flex \
  perl python3 \
  elfutils-libelf-devel openssl-devel \
  ncurses-devel \
  dwarves \
  rsync git \
  dracut \
  grub2-tools grubby
```

说明：

* `dwarves/pahole` 常用于 BTF/调试信息相关配置。
* `dracut` 用于生成 initramfs。
* `grubby` 用于向 GRUB 添加/设置启动项（比手改 grub.cfg 稳）。

---

### 4.3 在开发板上编译内核（本机 native 编译）

假设源码目录为 `/root/openeuler-5.10.0-136-src`（你按实际改）。

#### 4.3.1 编译前确认配置

进入源码目录：

```bash
tar -xf ~/openeuler-5.10.0-136-src-master.tar.gz
cd ~/openeuler-5.10.0-136-src-master
```

准备配置文件：

* 如果你已经有 `.config`（你当前就是这种），直接：

```bash
cp ~/config-5.10.0-136.12.0.86.aarch64 .config
make olddefconfig
```

如果要修改配置

```text
make menuconfig
```

#### 4.3.2 正式编译

```bash
make -j"$(nproc)" Image modules dtbs
```

常见产物位置：

* 内核镜像：`arch/arm64/boot/Image`
* DTB：`arch/arm64/boot/dts/**/*.dtb`
* 模块：编译后在源码树中，安装后进入 `/lib/modules/<release>/`

---

### 4.4 安装新内核到系统

#### 4.4.1 获取新内核 release（版本号）

在源码树内：

```bash
cd /root/openeuler-5.10.0-136-src
KREL=$(make -s kernelrelease)
echo "$KREL"
```

后面所有路径都用 `${KREL}`，避免手填错。

#### 4.4.2 安装内核模块

```bash
sudo make modules_install
```

检查模块目录是否存在：

```bash
ls -ld /lib/modules/"$KREL"
```

#### 4.4.3 安装内核

```text
make install
```

---

## 5. 添加 GRUB 启动项并设为默认启动

你看到 `/boot/loader/entries/` 为空是正常的，因为你用的是 GRUB2，并且你是手工安装内核文件，不会自动生成 BLS 条目。最稳方案是用
`grubby`。

### 5.1 添加新启动项（复制当前默认内核参数）

```bash
sudo grubby \
  --add-kernel=/boot/vmlinuz-"$KREL" \
  --initrd=/boot/initramfs-"$KREL".img \
  --title="openEuler (${KREL}) custom" \
  --copy-default
```

### 5.2 设为默认启动项

```bash
sudo grubby --set-default /boot/vmlinuz-"$KREL"
sudo grubby --default-kernel
```

查看所有启动项（确认新项存在）：

```bash
sudo grubby --info=ALL | less
```

### 5.3 重启验证

```bash
reboot
```

启动后确认：

```bash
uname -a
uname -r
```

应当显示为你刚才的 `${KREL}`，并且你已验证“新内核能识别以太网接口”。

---

## 6. 配置有线网络（PC 直连，静态 IP）

你之前 DHCP 卡住、超时，本质是直连场景通常没有 DHCP Server，所以 `nmcli con up` 会一直等租约。直连最好的做法是静态地址 +
不设网关。

假设：

* PC 以太网：`192.168.11.100/24`
* 开发板：`192.168.11.125/24`
* 开发板接口：`enaphyt4i0`

### 6.1 在开发板上用 NetworkManager 配静态 IP（持久化）

先清理可能冲突的连接（有就删，没就忽略）：

```bash
nmcli con show
sudo nmcli con down enaphyt4i0-dhcp 2>/dev/null || true
sudo nmcli con delete enaphyt4i0-dhcp 2>/dev/null || true
sudo nmcli con delete "Wired connection 1" 2>/dev/null || true
```

新建一个干净的**静态连接**：

```bash
sudo nmcli con add type ethernet ifname enaphyt4i0 con-name enaphyt4i0-static \
  ipv4.method manual ipv4.addresses 192.168.11.125/24 \
  ipv4.gateway "" ipv4.dns "" ipv4.never-default yes \
  ipv6.method ignore \
  connection.autoconnect yes

sudo nmcli con up enaphyt4i0-static
```

验证 IP 是否存在且不会“过一会儿消失”：

```bash
ip -4 a show dev enaphyt4i0
nmcli -f GENERAL.STATE,GENERAL.CONNECTION,IP4.ADDRESS dev show enaphyt4i0
ip route
```

重点：

* `ipv4.never-default yes`：保证这根直连线不会抢默认路由，避免你 PC 侧/其他网口上网被干扰。
* 如果 IP “过一会儿消失”，优先查链路是否抖动：网线/网卡省电/自协商。用下面命令能直接看 carrier 是否掉：

```bash
watch -n 1 'date; cat /sys/class/net/enaphyt4i0/carrier; ip -4 a show dev enaphyt4i0'
```

### 6.2 PC 侧静态 IP

把 PC 的以太网口设置为：

* IP：`192.168.11.100`
* 掩码：`255.255.255.0`
* 网关：留空
* DNS：留空

（你怎么配我不展开了，目标是保证 PC 能 ping 到 192.168.11.125。）

### 6.3 连通性验证

开发板上：

```bash
ping -c 3 192.168.11.100
```

PC 上：

```bash
ping 192.168.11.125
```

---

## 7. 开启 SSH 远程登录

> 注意，配置好 IP 之后直接 SSH 登录，一般是可以成功的，就不用继续画蛇添足了。

你现在“能 ping 但不能 SSH”，通常就是 sshd 没启动或防火墙没放行。

### 7.1 安装并启动 sshd

```bash
sudo dnf install -y openssh-server
sudo systemctl enable --now sshd
sudo ss -lntp | grep ':22' || true
```

### 7.2 放行防火墙（如果启用 firewalld）

```bash
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

### 7.3 root 登录策略（需要时才改）

查看配置：

```bash
sudo grep -E '^(PermitRootLogin|PasswordAuthentication)' /etc/ssh/sshd_config
```

如果你发现 root 禁止或密码登录禁用，按需调整（只对你这台实验/直连环境使用）：

```bash
sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sudo systemctl restart sshd
```

PC 上登录：

```bash
ssh root@192.168.11.125
```
