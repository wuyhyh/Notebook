# Fedora 编译内核后的启动管理与删除流程

---

适用于 **Fedora 系统启用 BLS（BootLoaderSpec）模式**的情况，流程涵盖：

> ✅ 安装完自己编译的内核（通过 `make install`）后
> ✅ 切换默认启动内核 or 临时启动
> ✅ 删除自编译内核

---

## 一、前提假设

* 你通过如下命令安装了内核：

  ```bash
  make -j$(nproc)
  sudo make modules_install
  sudo make install
  ```
* 此时生成的文件有：

    * `/boot/vmlinuz-6.16.0+`
    * `/boot/initramfs-6.16.0+.img`
    * `/boot/loader/entries/<machine-id>-6.16.0+.conf`

---

## 二、切换启动内核

### 1. 查看现有启动项（BLS 条目）

```bash
grep ^title /boot/loader/entries/*.conf
```

输出示例：

```
/boot/loader/entries/8e281c2e90a44533834e57b420c599a9-0-rescue.conf:
    title Fedora Linux (0-rescue-8e281c2e90a44533834e57b420c599a9) 42 (Server Edition)
/boot/loader/entries/8e281c2e90a44533834e57b420c599a9-6.14.0-63.fc42.x86_64.conf:
    title Fedora Linux (6.14.0-63.fc42.x86_64) 42 (Server Edition)
```

也可以列出条目文件名：

```bash
ls /boot/loader/entries/
```

```text
[root@Fedora ~]# ls /boot/loader/entries/
2f88f64cb26a4c31afec27c8a0dcb800-0-rescue.conf
2f88f64cb26a4c31afec27c8a0dcb800-6.16.0+.conf
2f88f64cb26a4c31afec27c8a0dcb800-6.14.0-63.fc42.x86_64.conf
```

前面很长的部分是 machine id

```shell
cat /etc/machine-id
```

---

### 2. 设置默认启动（永久生效）

```bash
sudo grub2-set-default <entry-name>
```

示例：

```bash
sudo grub2-set-default 2f88f64cb26a4c31afec27c8a0dcb800-6.14.0-63.fc42.x86_64
```

验证：

```bash
grub2-editenv list
```

---

### 3. 设置临时启动（仅下一次生效）

```bash
sudo grub2-reboot <entry-name>
```

例如：

```bash
sudo grub2-reboot 2f88f64cb26a4c31afec27c8a0dcb800-6.14.0-63.fc42.x86_64
```

---

### 4. 重启并验证当前运行内核

```bash
reboot
```

开机后：

```bash
uname -r
```

应为你指定的内核版本。

显示多个系统相关的信息和logo

```shell
fastfetch
```

---

## 三、删除自编译安装的内核（非 RPM 管理）

### 注意：

> 请确保当前**不是在运行你要删除的内核**
> 例如先用 `uname -r` 确保当前不是 `6.16.0+`

---

### 1️⃣ 删除 BLS 启动项

```bash
sudo rm /boot/loader/entries/*6.16.0+.conf
```

---

### 2️⃣ 删除内核镜像文件

```bash
sudo rm /boot/vmlinuz-6.16.0+
sudo rm /boot/initramfs-6.16.0+.img
sudo rm /boot/System.map-6.16.0+
sudo rm /boot/config-6.16.0+
```

可先预览：

```bash
ls /boot/*6.16.0+*
```

---

### 3️⃣ 如果默认启动项指向该内核，还需改回：

```bash
sudo grub2-set-default <其他内核的 entry>
```

例如：

```bash
sudo grub2-set-default 2f88f64cb26a4c31afec27c8a0dcb800-6.14.0-63.fc42.x86_64
```

---

### 4️⃣ 最终确认

```bash
ls /boot/vmlinuz*
ls /boot/loader/entries/
grub2-editenv list
```

确保你删除的内核和启动项都已不在。

---

## 附：如何避免这种手动删除？——建议使用 [rpm 安装内核](./rpm编译安装内核.md)

```bash
make -j$(nproc) rpm-pkg
```

然后用 `dnf install kernel-*.rpm`，可用 `dnf remove` 自动管理，推荐用于生产系统。

---
